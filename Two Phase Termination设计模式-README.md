# Two Phase Termination设计模式
  当一个线程正常结束，或者因被打断而结束，或者因为出现异常而结束时，我们需要考虑如何释放线程中的资源，比如文件
句柄、socket套接字句柄、数据库连接等比较稀缺的资源。
  Two Phase Termination设计模式如下所示：
  开始->作业中->终止要求->终止处理->释放资源->结束
  当希望结束这个线程时，发出线程结束请求，接下来线程不会立即结束，而是会执行相应的资源释放动作直到真正的结束，
在终止处理状态时，线程虽然还在运行，但是进行的是终止处理工作，因此终止处理也被称为线程结束的第二阶段，而受理
终止要求则被称为线程结束的第一阶段。
  在进行线程两阶段终止的时候需要考虑如下几个问题：
  1、第二阶段终止的安全性保证，比如涉及到共享资源的操作。
  2、要百分之百的保证线程结束，假设在第二阶段出现了死循环、阻塞等异常会导致线程无法结束。
  3、对资源的释放时间要控制在一个可控范围内。
  
  Two Phase Termination与其说是一个模式，还不如说是线程使用的一个技巧(best practice)。其主要针对的是
当前线程生命周期结束时，能有机会做一些资源释放动作。

  当一个jvm进程主动关闭或者异常关闭的时候，可不可以也进行两阶段的termination呢？
  我们通过为进程注入一个或者多个hook线程的方式进行两阶段的终止。
  
  无论是File还是Socket等重量级资源(严重依赖操作系统资源)，在进行释放时并不能百分之百的保证成功(可能是操作系统的原因)。
比如，对socket关闭时可能失败，socket的实例被垃圾回收器回收了，但是socket实例对应的底层资源或许并未释放。
那么我们有什么办法可以再次尝试对socket进行资源释放操作呢？我们可借助PhantomReference(JDK提供的对象被垃圾回收时的可跟踪机制)
就可以很好地获取到是哪个对象即将被垃圾回收器清除，在被清除之前还可以尝试一次资源回收，尽最大努力回收重量级的资源是一种非常好的
编程体验。案例见com.chenjj.concurrent.reference下的例子。